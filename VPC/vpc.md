# Amazon VPC (Virtual Private Cloud)

사용자가 사용하는 AWS 리소스를 논리적으로 격리하여 프로비저닝하는 방법이다. 격리된 공간에 대해  IP 주소 범위 선택, 서브넷 생성, 라우팅 테이블 및 네트워크 게이트웨이 구성 등 가상 네트워킹 환경을 제어 가능하다.
이 VPC 위에서 EC2나 RDS 같은 데이터베이스를 생성하여 사용가능하다. 기본적으로 AWS 는 네트워크를 통해 서비스하기 때문에, 격리된 네트워크 환경을 통해 특정 리소스에 접근할 수 있는 환경을 만들어 주는 것이 VPC 의 목적이다.

## 기본 VPC 구성 요소

- VPC
- Subnet
- Route Table
- Network ACL / Security Group
- Internet Gateway
- DHCP options set

### VPC

프라이빗 클라우드를 만드는데 가장 기본이 되는 리소스이며, 논리적인 네트워크를 구성하는 리소스이다.   VPC 의 이름과 IPv4 CIDR 블록이 필수 요소이다.
CIDR 블록은 IP의 범위를 지정하는 방식으로 IP주소 + `/` + 넷마스크 숫자로 구성되어있다.  넷마스크는 IP의 범위를 나타내며, 범위는 2^(32-n)개가 지정된다.
- 192.168.0.0/32
    - 정확히 지정된 IP를 명시
- 192.168.0.0/24
    - 192.168.0.0 ~ 192.168.0.255 까지를 지정
- 넷마스크가 8의 배수가 아닌 경우
    - 8의 배수는 255, 즉 `.`으로 구분된 부분 전체를 나타내는 것을 기본으로 2의 배수로 생각해봐야한다
    - 192.168.0.0/23 or /22
        - 23의 경우 24보다 2배 많은 수를 표현하므로 192.168.0.0 ~ 192.168.1.255 까지 범위가 된다
        - 22의 경우 24보다 4배 많은 수를 표현하므로 192.168.0.0 ~ 192.168.3.255 까지 범위가 된다
        - 밤대로 25의 경우 1/2 범위가 되므로, 192.168.0.128 ~ 192.168.0.255 가 범위가 된다
          VPC 하나에 최대 크기는 16이며,  즉, 65536개의 IP가 할당가능하며 적절한 크기의 VPC 를 만들어야한다.  또한 인터넷 연결이 필요한 경우, 사설망 대역을 사용해야하기 때문에 이에 해당하는 대역을 사용하는 것을 권장한다.

### Subnet

VPC는 CIDR 블록으로 나뉘어진 논리적인 공간으로, 실제 리소스가 생성되는 곳은 가용존(Available Zone)으로 서브넷과 연결된다.
즉, `실제 리소스가 생성되는 네트워크`라고 볼 수 있다.

- 서브넷의 최대 크기는 VPC 의 크기와 같다
- 일반적으로 가용존의 갯수만큼 서브넷을 만들어 리소스를 분산시켜 재해 대응을 한다.
  - 하나의 서브넷은 하나의 가용존과 연결되며 리전에 따라 사용 가능한 가용존의 갯수가 달라진다
- 기본 VPC 에서는 가용존 갯수만큼 넷마스크 20의 서브넷을 자동으로 생성한다

### Route Table

서브넷에서 네트워크를 이용할 때 라우트 테이블을 사용해서 목적지를 찾게된다. VPC 에도 연결되어 있으며 이때 연결된 라우트 테이블은
VPC 에서 만들어지는 서브넷의 기본 라우트 테이블로 지정된다.

- 주의점
  - 라우트 테이블 하나는 VPC 내 여러 서브넷에서 사용 가능한데, 이렇게 자동 생성되는 라우트 테이블에는 하나의 룰만이 지정되어 있다.
  - 바로 같은 CIDR 블럭을 목적지로 하는 네트워크의 경우 로컬 즉, VPC 내에서 리소스를 찾는 규칙이다.
  - 따라서, 인터넷을 연결하거나 다른 VPC 와 통신하기 위해서는 규칙을 추가적으로 정의 해줘야한다.

### Internet Gateway

VPC 는 기본적으로 격리된 네트워크 환경이기 때문에, 인터넷에 연결하기 위해서는 인터넷 게이트웨이와 연결해줘야한다.
따라서, 라우팅 테이블에 인터넷 게이트웨이를 향하는 규칙을 추가해주면 서브넷은 인터넷과 연결된다.
단, `인터넷을 사용하고자 하는 리소스는 반드시 퍼블릭IP` 를 가지고 있어야한다.

### DHCP options set

DHCP 옵션셋은 TCP/IP 상의 호스트로 설정 정보를 전달하는 DHCP 표준이다. 보통 VPC 생성 시, 생성되는 그대로를 사용한다.

### Network ACL / Security Group

두 개 모두 Inbound 와 Outbound 트래픽을 제어하는 가상 방화벽이다. 다만 시큐리티 그룹은 인스턴스의 앞에서 트래픽을 제어한다면,
네트워크 ACL 은 서브넷 앞단에서 트랙픽을 제어하는 방화벽이라고 볼 수 있다. 또한, `시큐리티 그룹은 stateful`하게 동작하기에, 인바운드에
성공한다면 아웃바운드 설정을 안하더라도 동작이 가능하지만, `ACL 은 stateless`하기 때문에 인바운드 아웃바운드 모두 설정해줘야 정상적으로
동작한다. 두 개가 독립적으로 동작하기 때문에, ACL 에서 통과하더라도 시큐리티 그룹에서 실패하면 통신이 되지 않는다.